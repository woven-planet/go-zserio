name: Run tests

on: push

jobs:
  test:
    name: Run tests

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
       
      - name: Mount bazel cache
        uses: actions/cache@v2
        with:
          path: "~/.cache/bazel"
          key: bazel

      - name: Install Dependencies
        run: python -m pip install "zserio==2.4.2"
        
      - name: Generate the Python zserio code using reference zserio
        run: python -m zserio -src $PWD/testdata reference_modules/all.zs -setTopLevelPackage testdata -python $PWD/test/python
        
      - name: Generate the Go zserio code using go-zserio
        run: bazel run //zserio -- generate $PWD/testdata -r github.com/woven-planet/go-zserio/test/go-schema -o $PWD/test/go-schema

      - name: Generate the Bazel files for the generated code
        run: bazel run //:gazelle
        
      - name: Workaround - restore the bazel files for the generator
        run: git restore $PWD/internal/parser/BUILD.bazel

      - name: Generate zserio dummy data
        working-directory: test
        run: python3 python/write_test_data.py


      - run: bazel test //...
        


